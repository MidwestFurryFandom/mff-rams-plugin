{% extends 'uber/templates/forms/attendee/personal_info.html' %}

{% block x_data %}
{{ super() }}
birthdate: '{{ personal_info.birthdate.data|default('', true) }}',
consent_form: {{ (attendee.birthdate and attendee.age_group_conf['consent_form'])|boolean|tojson }},
toggleConsentFormEmail(data) {
  if(data.birthdate.match(/\d{2}\/\d{2}\/\d{4}/)) {
    $.ajax({
      method: 'GET',
      url: '../preregistration/_check_consent_form',
      dataType: 'json',
      data: {
          birthdate: data.birthdate
      },
      success: function (json) {
        data.consent_form = json.consent_form
      }
  });
  }
  return false;
},
get mffOnsiteContactRequired() { return this.onsiteContactRequired && !this.badge_ribbons.includes({{ c.STAFF_RIBBON }}) },
get mffCellphoneRequired() { return (this.dealer || this.badge_type == {{ c.STAFF_BADGE }} || this.badge_ribbons.includes({{ c.STAFF_RIBBON }})) && !this.no_cellphone && !this.copy_cellphone && !this.badge_placeholder },
{% endblock %}

{% block age %}
  <div class="col-sm" x-init="$watch('birthdate', (value) => toggleConsentFormEmail($data))">
    {% call form_macros.input(personal_info.birthdate, admin_text=attendee.age_group_conf.desc, alpine_model="birthdate", required_if="!badge_placeholder") %}
    <div x-show="consent_form">{{ form_macros.input(personal_info.consent_form_email, required_if="consent_form && !badge_placeholder") }}</div>
    {% endcall %}
  </div>

  <div class="col-sm">
    {% if admin_area %}
    <div x-show="consent_form">{{ form_macros.input(personal_info.consent_form_email, required_if="consent_form && !badge_placeholder") }}</div>
    {% else %}
    <div class="alert alert-warning mb-0" role="alert">
      {% if False %}
      <em>
        Please review our <a href="https://www.furfest.org/support/parents-guide" target="_blank">Parent's Guide</a> for more information about FurFest's policies 
        regarding the attendance of those under 18 years of age.
      </em>
      {% else %}
      <em>
        At this time {{ c.EVENT_NAME }} is not accepting registrations for our Minor (17 years old and younger) attendees. Please review <a href="https://www.furfest.org/attend/register" target="_blank">our policies</a> for more details.
      </em>
      {% endif %}
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block contact_info %}
  {% set attendee_email = attendee.masked_email if limited_read else attendee.email %}
  <div class="col-sm">
    {% call form_macros.input(personal_info.email, value=attendee_email, required_if="emailRequired", **{':disabled':'copy_email'}) %}
      {% if is_prereg_dealer %}
        {{ form_macros.input(personal_info.copy_email, **{'x-model.boolean':'copy_email'}) }}
      {% endif %}
    {% endcall %}
  </div>
  {% if c.PREREG_CONFIRM_EMAIL_ENABLED and not admin_area and (attendee.needs_pii_consent or attendee.badge_status == c.PENDING_STATUS) %}
    <div class="col-sm">
      {{ form_macros.input(personal_info.confirm_email, value=attendee_email if edit_id or attendee.placeholder else '',
                           required_if="emailRequired", **{':disabled':'copy_email'}) }}
    </div>
    </div>
    <div class="row g-3 mb-3">
  {% endif %}
  <div class="col-sm">
    {% call form_macros.input(personal_info.cellphone, required_if="mffCellphoneRequired", **{':disabled':'disableCellphone'}) %}
      {% if is_prereg_dealer %}
        {{ form_macros.input(personal_info.copy_phone, **{'x-model.boolean':'copy_cellphone'}) }}
      {% else %}
        <div x-show="mffCellphoneRequired || no_cellphone">
        {{ form_macros.input(personal_info.no_cellphone, **{'x-model.boolean':'no_cellphone'}) }}
        </div>
      {% endif %}
    {% endcall %}
  </div>
{% endblock %}

{% block ec_info %}
{% set show_ec = admin_area and ((attendee.admin_read_access() and attendee.admin_read_access() > 2) or c.HAS_REG_ADMIN_ACCESS or c.HAS_SECURITY_ADMIN_ACCESS) or (attendee.is_new or not admin_area) %}
{% if show_ec or not personal_info.ec_name.data %}
  <div class="col-sm">
    {{ form_macros.input(personal_info.ec_name, required_if="!badge_placeholder") }}
  </div>
  <div class="col-sm">
    {{ form_macros.input(personal_info.ec_phone, required_if="!badge_placeholder") }}
  </div>
{% endif %}
{% if show_ec or not personal_info.onsite_contact.data %}
</div>
<div class="row g-3 mb-3">
  <div class="col-sm">
      {{ form_macros.input(personal_info.onsite_contact, extra_field=onsite_extra_field, maxlength="500", required_if="mffOnsiteContactRequired", **{':disabled':'no_onsite_contact'}) }}
      {{ form_macros.input(personal_info.no_onsite_contact, **{'x-model.boolean':'no_onsite_contact'}) }}
  </div>
  <div class="col-sm">
    <div class="alert alert-info mb-0" role="alert">
    Please provide names and contact info for a trusted friend or friends who will be at or near the venue during the event.
    </div>
  </div>
{% endif %}
{% endblock %}